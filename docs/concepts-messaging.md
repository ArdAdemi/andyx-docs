# Messaging

Andy X is bult on the publish-subscribe pattern (often abbreviated to pub-sub). In this pattern, producers publish messages to a topic, consumers subscribe to those topics, process incoming messages, and sent acknowledgements to the node when processing is finished.

When a Consumer is created, Andy X stores all messages, even if the consumer is not connected. The retained messages are discarded only when a consumer acknowledges that all these messages are processed successfully.

If the consumption of a message fails, that message will be sent from the Node to re-consume when the consumer is re-connected with the Node.

# Message

Messages are the basic unit of Andy X. The following table lists the components of the message.

| Component  | Description  | 
| :------------ |:---------------:|
| Id | GUID/UUID autogenerated Message ID |
| Headers | An optional key/value map of user-defined properties.|
| Producer name | The name of the producer who produces the message. If you do not specify a producer name, the default name is used.|
| Tenant | Tenant name when message will be streamed|
| Product | Product name when message will be streamed|
| Component | Component name when message will be streamed|
| Topic | Topic name when message will be streamed|
| SentDate | The timestamp of when the message is published. The timestamp is automatically applied by the producer.|

# Producers

A producer is a process that attaches to a topic and publishes messages to a Andy X Node. The Andy X Node processes the messages.

## Send Mode
Producers send messages to brokers synchronously (sync) or asynchronously (async).

## Access Mode

Producers in the current version of Andy X v2.1.x supports only **Shared** Access Mode

### Shared Access Mode
Multiple producers can publish on a topic.

?> **Exclusive and Failover**
We are working to bring into Andy X v2.2 new Access Modes which will be configured into **Topic Settings**.

## Batching

Producers also can produce messages as batch of messages in a signle request. The batch size is defined by the maximum numner of messages and the maximum publish latency.
In Andy X, batches are tracked and stored as individual messages and not as a single units, this means that the Consumers will consume these messages as individual messages.

# Consumers

A consumer is a process that attaches to a topic with a subscription and then receives messages.
A consumer first asks the Node to connect, if the node can do the authorization and validation of the requested consumer it will connect the consumer, and thats it. Node will take care to push messages to the Consumer. There are no need to configure the queue size. If a message arrives from the Producers to the Node, Node will persist the message and it will push it to the consumers that are connected. While storing the message the Andy X Storage Service will update the pointers for consumers that are not already connected.

Consumers in Andy X can do only asynchronous receiveing of messages. 

Already, in Andy X there are three different types of consumers. These types tells the Nodes how to send messages to that Consumer.

### Exclusive
In Exclusive type, only a single consumer is allowed to attach to the topic. If multiple consumers subscribe to a topic using the same consumer name, an error occurs.

### Shared
In shared or round robin type, multiple consumers can attach to the same topic. Messages are delivered in a round robin distribution across consumers, and any given message is delivered to only one consumer. When a consumer disconnects, all the messages that were sent to it and not acknowledged will be rescheduled for sending to the remaining consumers.

### Failover
Failover type, is Exclusive type with a failover consumer. If the first consumer is disconencted or faild to consume the message, node will contine pushing messages to that fail-over consumer.

## Acknowledgement
The consumer sends an acknowledgement request to the Node after it consumes a message successfully.
Then, this consumed message will be permanently stored, and be deleted only after all the subscriptions have acknowledged it. If you want to store the messages that have been acknowledged by a consumer, you need to configure the message retention policy.

Messages can be acknowledged onlu individually. With individual acknowledgement, the consumer acknowledges each message and sends an acknowledgement request to the Node.
Using Andy X Client APIs the event method will return true or false which determinates if the message has been acked or not.
```csharp

        private bool Consumer_MessageReceived(object sender, Andy.X.Client.Events.Consumers.MessageReceivedArgs<SimpleMessage> e)
        {
            Console.WriteLine($"Message arrived: payload as raw: '{e.Payload}'; payload as simpleMessage name='{e.GenericPayload.Name}'");

            // Message acknowledged
            return true;
        }
```
## Simple Consumer

Below you will find a simple code example how to create a new consumer

```csharp
        consumer = Consumer<SimpleMessage>.CreateNewConsumer(client)
            .ForComponent("simple")
            .AndTopic("simple-message")
            .WithName("simple-consumer")
            .WithInitialPosition(InitialPosition.Earliest)
            .AndSubscriptionType(SubscriptionType.Exclusive)
            .Build();

            consumer.MessageReceived += Consumer_MessageReceived;

        consumer
            .ConnectAsync()
            .Wait();
```

# Topics
As in other pub-sub systems, topics in Andy X are named channels for transmitting messages from producers to consumers. Topic names well defined and are stored inside the Tenant/Product/Component/**Topic**

    e.g,
    {tenant}/{Product}/{Component}/{Topic}
    default/transactions/application/txn-received

With Andy X, topics can be created as **persistent** or **non-persistent**
This identifies the type of topic. Andy X supports two kind of topics: persistent and non-persistent. The default is persistent, so if you do not specify a type, the topic is persistent. With persistent topics, all messages are durably persisted on disks (if the node is not single instance, messages are durably persisted on multiple disks), whereas data for non-persistent topics is not persisted to storage disks.

### Tenant
The topic tenant within the instance. Tenants are essential to multi-tenancy in Andy X, and spread across the cluster (n-nodes and n-storages).

?> **Tenants can be configured at that form that Products, Components and Topics can be auto-created from Producers or consumers.**

### Product
The administrative unit of the component, which acts as a grouping mechanism for related components. The idea behind Products is Data Mesh concept. This Products can be defined as Data Products inside the organization.

### Component 
Most topic configuration is performed at the Component level. Each product has one or multiple components.

Tenants, Products, Components and Topics can be created via Andy X Cli.